// Á∞°Âçò„ÅßÂ†ÖÁâ¢„Å™Marp PWA„Ç®„Éá„Ç£„Çø„Éº
(function() {
    'use strict';
    
    // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Áä∂ÊÖã
    const state = {
        isSlideMode: true,
        currentSlide: 0,
        slides: [],
        elements: {}
    };
    
    // „Éá„Éï„Ç©„É´„Éà„Ç≥„É≥„ÉÜ„É≥„ÉÑ
    const defaultMarkdown = `---
marp: true
theme: default
---

# Marp PWA „Ç®„Éá„Ç£„Çø„Éº
Markdown„Åã„Çâ„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê

---

## Ê©üËÉΩÁ¥π‰ªã
- **„É™„Ç¢„É´„Çø„Ç§„É†„Éó„É¨„Éì„É•„Éº**
- **„Çπ„É©„Ç§„Éâ‚áîMarkdownË°®Á§∫Âàá„ÇäÊõø„Åà**
- **PDF/PPTX/HTMLÂá∫Âäõ**
- **Ëá™Âãï‰øùÂ≠ò**

---

## ‰Ωø„ÅÑÊñπ
1. Â∑¶„Éö„Ç§„É≥„ÅßMarkdown„ÇíÁ∑®ÈõÜ
2. Âè≥„Éö„Ç§„É≥„Åß„Éó„É¨„Éì„É•„ÉºÁ¢∫Ë™ç
3. „Éó„É¨„Éì„É•„Éº„É¢„Éº„Éâ„ÇíÂàá„ÇäÊõø„Åà
4. „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åß‰øùÂ≠ò

---

# „ÅØ„Åò„ÇÅ„Åæ„Åó„Çá„ÅÜÔºÅ
Á¥†Êô¥„Çâ„Åó„ÅÑ„Çπ„É©„Ç§„Éâ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ üéâ`;

    // DOMË¶ÅÁ¥†„ÇíÂèñÂæó
    function getElements() {
        const ids = [
            'loading', 'errorDisplay', 'app', 'markdownEditor', 'previewContent', 
            'previewTitle', 'charCount', 'slideCounter', 'prevSlide', 'nextSlide',
            'saveBtn', 'exportBtn', 'settingsBtn', 'previewToggle',
            'exportModal', 'settingsModal', 'closeExport', 'closeSettings',
            'exportPdf', 'exportPptx', 'exportHtml', 'exportMarkdown', 'applySettings'
        ];
        
        ids.forEach(id => {
            state.elements[id] = document.getElementById(id);
        });
    }
    
    // ÊñáÂ≠óÊï∞„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞
    function updateCharCount() {
        const editor = state.elements.markdownEditor;
        const counter = state.elements.charCount;
        if (editor && counter) {
            counter.textContent = `${editor.value.length}ÊñáÂ≠ó`;
        }
    }
    
    // Markdown„ÇíHTML„Å´Â§âÊèõ
    function markdownToHtml(markdown) {
        if (!markdown) return '';
        
        return markdown
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/^\* (.*$)/gim, '<li>$1</li>')
            .replace(/^\- (.*$)/gim, '<li>$1</li>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>')
            .replace(/(<li>.*?<\/li>)/g, '<ul>$1</ul>')
            .replace(/<\/ul>\s*<ul>/g, '')
            .replace(/^(.*)$/m, '<p>$1</p>')
            .replace(/<p><h([1-6])>/g, '<h$1>')
            .replace(/<\/h([1-6])><\/p>/g, '</h$1>')
            .replace(/<p><ul>/g, '<ul>')
            .replace(/<\/ul><\/p>/g, '</ul>');
    }
    
    // „Çπ„É©„Ç§„Éâ„Å´ÂàÜÂâ≤
    function splitIntoSlides(markdown) {
        const slides = markdown.split(/^---\s*$/m);
        return slides.filter(slide => slide.trim()).map(slide => markdownToHtml(slide.trim()));
    }
    
    // „Éó„É¨„Éì„É•„ÉºÊõ¥Êñ∞
    function updatePreview() {
        const editor = state.elements.markdownEditor;
        const preview = state.elements.previewContent;
        
        if (!editor || !preview) return;
        
        const markdown = editor.value;
        
        if (state.isSlideMode) {
            // „Çπ„É©„Ç§„Éâ„É¢„Éº„Éâ
            state.slides = splitIntoSlides(markdown);
            
            // ÁèæÂú®„ÅÆ„Çπ„É©„Ç§„Éâ„Ç§„É≥„Éá„ÉÉ„ÇØ„ÇπË™øÊï¥
            if (state.currentSlide >= state.slides.length) {
                state.currentSlide = Math.max(0, state.slides.length - 1);
            }
            
            // „Çπ„É©„Ç§„ÉâË°®Á§∫
            const slideContent = state.slides[state.currentSlide] || '<p>„Çπ„É©„Ç§„Éâ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            preview.innerHTML = `<div class="slide-wrapper"><section class="basic-slide">${slideContent}</section></div>`;
            
            // „Çπ„É©„Ç§„Éâ„Ç´„Ç¶„É≥„Çø„ÉºË°®Á§∫
            updateSlideCounter();
            showSlideControls();
        } else {
            // Markdown„É¢„Éº„Éâ
            const html = markdownToHtml(markdown);
            preview.innerHTML = `<div class="markdown-preview">${html}</div>`;
            hideSlideControls();
        }
    }
    
    // „Çπ„É©„Ç§„Éâ„Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
    function updateSlideCounter() {
        const counter = state.elements.slideCounter;
        if (counter) {
            const total = Math.max(1, state.slides.length);
            const current = Math.max(1, state.currentSlide + 1);
            counter.textContent = `${current} / ${total}`;
        }
    }
    
    // „Çπ„É©„Ç§„Éâ„Ç≥„É≥„Éà„É≠„Éº„É´Ë°®Á§∫
    function showSlideControls() {
        ['slideCounter', 'prevSlide', 'nextSlide'].forEach(id => {
            const el = state.elements[id];
            if (el) el.style.display = 'inline-block';
        });
    }
    
    // „Çπ„É©„Ç§„Éâ„Ç≥„É≥„Éà„É≠„Éº„É´ÈùûË°®Á§∫
    function hideSlideControls() {
        ['slideCounter', 'prevSlide', 'nextSlide'].forEach(id => {
            const el = state.elements[id];
            if (el) el.style.display = 'none';
        });
    }
    
    // „Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà
    function togglePreviewMode() {
        state.isSlideMode = !state.isSlideMode;
        
        const toggleBtn = state.elements.previewToggle;
        const title = state.elements.previewTitle;
        
        if (toggleBtn) {
            toggleBtn.textContent = state.isSlideMode ? 'üìù MarkdownË°®Á§∫' : 'üéØ „Çπ„É©„Ç§„ÉâË°®Á§∫';
            toggleBtn.className = state.isSlideMode ? 'btn btn--primary btn--sm' : 'btn btn--secondary btn--sm';
        }
        
        if (title) {
            title.textContent = state.isSlideMode ? '„Çπ„É©„Ç§„Éâ„Éó„É¨„Éì„É•„Éº' : 'Markdown„Éó„É¨„Éì„É•„Éº';
        }
        
        updatePreview();
        showMessage(state.isSlideMode ? '„Çπ„É©„Ç§„ÉâË°®Á§∫„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü' : 'MarkdownË°®Á§∫„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
    }
    
    // Ââç„ÅÆ„Çπ„É©„Ç§„Éâ
    function previousSlide() {
        if (state.isSlideMode && state.currentSlide > 0) {
            state.currentSlide--;
            updatePreview();
        }
    }
    
    // Ê¨°„ÅÆ„Çπ„É©„Ç§„Éâ
    function nextSlide() {
        if (state.isSlideMode && state.currentSlide < state.slides.length - 1) {
            state.currentSlide++;
            updatePreview();
        }
    }
    
    // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    function downloadFile(content, filename, type) {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    // Markdown‰øùÂ≠ò
    function saveMarkdown() {
        const editor = state.elements.markdownEditor;
        if (editor) {
            downloadFile(editor.value, 'slides.md', 'text/markdown');
            showMessage('Markdown„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }
    }
    
    // PDFÂá∫Âäõ
    function exportToPDF() {
        window.print();
        showMessage('Âç∞Âà∑„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíÈñã„Åç„Åæ„Åó„Åü');
        hideModal('exportModal');
    }
    
    // PPTXÂá∫ÂäõÔºà„ÉÜ„Ç≠„Çπ„ÉàÂΩ¢ÂºèÔºâ
    function exportToPPTX() {
        const editor = state.elements.markdownEditor;
        if (editor) {
            const slides = editor.value.split(/^---\s*$/m).filter(s => s.trim());
            const content = slides.map((slide, i) => `===== „Çπ„É©„Ç§„Éâ ${i + 1} =====\n${slide.trim()}\n`).join('\n');
            downloadFile(content, 'slides-content.txt', 'text/plain');
            showMessage('„Çπ„É©„Ç§„Éâ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„Åß‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }
        hideModal('exportModal');
    }
    
    // HTMLÂá∫Âäõ
    function exportToHTML() {
        const editor = state.elements.markdownEditor;
        if (editor) {
            const slides = splitIntoSlides(editor.value);
            const html = `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marp Slides</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 2rem; background: #f5f5f5; }
        .slide { background: white; margin: 2rem auto; padding: 3rem; border-radius: 8px; 
                 box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 900px; min-height: 500px; }
        h1 { font-size: 2.5rem; color: #333; }
        h2 { font-size: 2rem; color: #444; }
        h3 { font-size: 1.5rem; color: #555; }
        strong { color: #2c5aa0; }
        @media print { .slide { page-break-after: always; margin: 0; box-shadow: none; } }
    </style>
</head>
<body>
    ${slides.map(slide => `<div class="slide">${slide}</div>`).join('')}
</body>
</html>`;
            downloadFile(html, 'slides.html', 'text/html');
            showMessage('HTML„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }
        hideModal('exportModal');
    }
    
    // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
    function showModal(id) {
        const modal = state.elements[id];
        if (modal) modal.classList.remove('hidden');
    }
    
    // „É¢„Éº„ÉÄ„É´ÈùûË°®Á§∫
    function hideModal(id) {
        const modal = state.elements[id];
        if (modal) modal.classList.add('hidden');
    }
    
    // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
    function showMessage(text, type = 'success') {
        const msg = document.createElement('div');
        msg.textContent = text;
        msg.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 3000;
            padding: 12px 16px; border-radius: 8px; font-size: 14px;
            background: ${type === 'success' ? '#d4edda' : '#f8d7da'};
            color: ${type === 'success' ? '#155724' : '#721c24'};
            border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};
        `;
        document.body.appendChild(msg);
        setTimeout(() => {
            if (msg.parentNode) msg.parentNode.removeChild(msg);
        }, 3000);
    }
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
    function setupEvents() {
        const { elements } = state;
        
        // „Ç®„Éá„Ç£„Çø„ÉºÂÖ•Âäõ
        if (elements.markdownEditor) {
            elements.markdownEditor.addEventListener('input', () => {
                updateCharCount();
                updatePreview();
            });
        }
        
        // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
        if (elements.prevSlide) elements.prevSlide.addEventListener('click', previousSlide);
        if (elements.nextSlide) elements.nextSlide.addEventListener('click', nextSlide);
        if (elements.saveBtn) elements.saveBtn.addEventListener('click', saveMarkdown);
        if (elements.exportBtn) elements.exportBtn.addEventListener('click', () => showModal('exportModal'));
        if (elements.settingsBtn) elements.settingsBtn.addEventListener('click', () => showModal('settingsModal'));
        if (elements.previewToggle) elements.previewToggle.addEventListener('click', togglePreviewMode);
        
        // „É¢„Éº„ÉÄ„É´
        if (elements.closeExport) elements.closeExport.addEventListener('click', () => hideModal('exportModal'));
        if (elements.closeSettings) elements.closeSettings.addEventListener('click', () => hideModal('settingsModal'));
        
        // „Ç®„ÇØ„Çπ„Éù„Éº„Éà
        if (elements.exportPdf) elements.exportPdf.addEventListener('click', exportToPDF);
        if (elements.exportPptx) elements.exportPptx.addEventListener('click', exportToPPTX);
        if (elements.exportHtml) elements.exportHtml.addEventListener('click', exportToHTML);
        if (elements.exportMarkdown) elements.exportMarkdown.addEventListener('click', saveMarkdown);
        
        // Ë®≠ÂÆö
        if (elements.applySettings) elements.applySettings.addEventListener('click', () => {
            hideModal('settingsModal');
            showMessage('Ë®≠ÂÆö„ÇíÈÅ©Áî®„Åó„Åæ„Åó„Åü');
        });
        
        // „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveMarkdown();
                } else if (e.key === 'p') {
                    e.preventDefault();
                    togglePreviewMode();
                }
            }
            if (e.key === 'Escape') {
                hideModal('exportModal');
                hideModal('settingsModal');
            }
        });
    }
    
    // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
    function initApp() {
        try {
            console.log('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ„Åó„Å¶„ÅÑ„Åæ„Åô...');
            
            // DOMË¶ÅÁ¥†ÂèñÂæó
            getElements();
            
            // ÂàùÊúü„Ç≥„É≥„ÉÜ„É≥„ÉÑË®≠ÂÆö
            if (state.elements.markdownEditor) {
                state.elements.markdownEditor.value = defaultMarkdown;
                updateCharCount();
            }
            
            // „Ç§„Éô„É≥„ÉàË®≠ÂÆö
            setupEvents();
            
            // ÂàùÊúü„Éó„É¨„Éì„É•„Éº
            updatePreview();
            
            // „Ç¢„Éó„É™Ë°®Á§∫
            if (state.elements.loading) state.elements.loading.style.display = 'none';
            if (state.elements.errorDisplay) state.elements.errorDisplay.classList.add('hidden');
            if (state.elements.app) state.elements.app.style.display = 'flex';
            
            console.log('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
            showMessage('„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅåÊ≠£Â∏∏„Å´Ëµ∑Âãï„Åó„Åæ„Åó„Åü');
            
        } catch (error) {
            console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
            
            // „Ç®„É©„ÉºË°®Á§∫
            if (state.elements.loading) state.elements.loading.style.display = 'none';
            if (state.elements.errorDisplay) {
                state.elements.errorDisplay.classList.remove('hidden');
                const errorMsg = document.getElementById('errorMessage');
                if (errorMsg) errorMsg.textContent = 'ÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message;
            }
        }
    }
    
    // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÂàùÊúüÂåñ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        initApp();
    }
    
    // „Ç∞„É≠„Éº„Éê„É´ÂèÇÁÖß
    window.MarpApp = { initApp, togglePreviewMode, showMessage };
    
})();
